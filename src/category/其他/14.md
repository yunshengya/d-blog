---
title: ä½ ä¸çŸ¥é“çš„ asyncã€awaité­”é¬¼ç»†èŠ‚
lang: zh-CN
author: æ©™çŒ«çŒ«
date: 2022-04-21 14:55:00
tags:
  - å…¶ä»–
category:
  - å…¶ä»–
---

## 0ã€å‰è¨€

---

å…³äº`promiseã€async/await`çš„ä½¿ç”¨ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´éƒ½æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œä½†æ˜¯æåˆ°**äº‹ä»¶å¾ªç¯æœºåˆ¶è¾“å‡ºç»“æœ**ç±»ä¼¼çš„é¢˜ç›®ï¼Œä½ æ•¢è¯´éƒ½ä¼šï¼Ÿ

è¯•ä¸€è¯•ï¼Ÿ

ğŸŒ°1ï¼š

```
async function async1 () {
    await new Promise((resolve, reject) => {
        resolve()
    })
    console.log('A')
}

async1()

new Promise((resolve) => {
    console.log('B')
    resolve()
}).then(() => {
    console.log('C')
}).then(() => {
    console.log('D')
})

// æœ€ç»ˆç»“æœğŸ‘‰: B A C D
```

ğŸŒ°2ï¼š

```
async function async1 () {
    await async2()
    console.log('A')
}

async function async2 () {
    return new Promise((resolve, reject) => {
        resolve()
    })
}

async1()

new Promise((resolve) => {
    console.log('B')
    resolve()
}).then(() => {
    console.log('C')
}).then(() => {
    console.log('D')
})

// æœ€ç»ˆç»“æœğŸ‘‰: B C D A
```

â“ åŸºæœ¬ä¸€æ ·çš„ä»£ç ä¸ºä»€ä¹ˆä¼šå‡ºç°å·®åˆ«ï¼Œè¯ä¸å¤šè¯´ ğŸ‘‡

## 1ã€async å‡½æ•°è¿”å›å€¼

---

åœ¨è®¨è®º `await` ä¹‹å‰ï¼Œå…ˆèŠä¸€ä¸‹ `async` å‡½æ•°å¤„ç†è¿”å›å€¼çš„é—®é¢˜ï¼Œå®ƒä¼šåƒ `Promise.prototype.then` ä¸€æ ·ï¼Œä¼šå¯¹è¿”å›å€¼çš„ç±»å‹è¿›è¡Œè¾¨è¯†ã€‚

ğŸ‘‰**æ ¹æ®è¿”å›å€¼çš„ç±»å‹ï¼Œå¼•èµ· `jså¼•æ“` å¯¹è¿”å›å€¼å¤„ç†æ–¹å¼çš„ä¸åŒ**

> ğŸ“‘ ç»“è®ºï¼š`async`å‡½æ•°åœ¨æŠ›å‡ºè¿”å›å€¼æ—¶ï¼Œä¼šæ ¹æ®è¿”å›å€¼**ç±»å‹**å¼€å¯**ä¸åŒæ•°ç›®çš„å¾®ä»»åŠ¡**
>
> - return ç»“æœå€¼ï¼šé`thenable`ã€é`promise`ï¼ˆä¸ç­‰å¾…ï¼‰
> - return ç»“æœå€¼ï¼š`thenable`ï¼ˆç­‰å¾… 1 ä¸ª`then`çš„æ—¶é—´ï¼‰
> - return ç»“æœå€¼ï¼š`promise`ï¼ˆç­‰å¾… 2 ä¸ª`then`çš„æ—¶é—´ï¼‰

ğŸŒ°1ï¼š

```
async function testA () {
    return 1;
}

testA().then(() => console.log(1));
Promise.resolve()
    .then(() => console.log(2))
    .then(() => console.log(3));

// (ä¸ç­‰å¾…)æœ€ç»ˆç»“æœğŸ‘‰: 1 2 3
```

ğŸŒ°2ï¼š

```
async function testB () {
    return {
        then (cb) {
            cb();
        }
    };
}

testB().then(() => console.log(1));
Promise.resolve()
    .then(() => console.log(2))
    .then(() => console.log(3));

// (ç­‰å¾…ä¸€ä¸ªthen)æœ€ç»ˆç»“æœğŸ‘‰: 2 1 3
```

ğŸŒ°3ï¼š

```
async function testC () {
    return new Promise((resolve, reject) => {
        resolve()
    })
}

testC().then(() => console.log(1));
Promise.resolve()
    .then(() => console.log(2))
    .then(() => console.log(3));

// (ç­‰å¾…ä¸¤ä¸ªthen)æœ€ç»ˆç»“æœğŸ‘‰: 2 3 1




async function testC () {
    return new Promise((resolve, reject) => {
        resolve()
    })
}

testC().then(() => console.log(1));
Promise.resolve()
    .then(() => console.log(2))
    .then(() => console.log(3))
    .then(() => console.log(4))

// (ç­‰å¾…ä¸¤ä¸ªthen)æœ€ç»ˆç»“æœğŸ‘‰: 2 3 1 4
```

çœ‹äº†è¿™ä¸‰ä¸ª ğŸŒ° æ˜¯ä¸æ˜¯å¯¹`ä¸Šé¢çš„ç»“è®º`æœ‰äº†æ›´æ·±çš„è®¤è¯†ï¼Ÿ

ç¨å®‰å‹¿èºï¼Œæ¥è¯•è¯•ä¸€ä¸ªç»å…¸é¢è¯•é¢˜ ğŸ‘‡

```
async function async1 () {
    console.log('1')
    await async2()
    console.log('AAA')
}

async function async2 () {
    console.log('3')
    return new Promise((resolve, reject) => {
        resolve()
        console.log('4')
    })
}

console.log('5')

setTimeout(() => {
    console.log('6')
}, 0);

async1()

new Promise((resolve) => {
    console.log('7')
    resolve()
}).then(() => {
    console.log('8')
}).then(() => {
    console.log('9')
}).then(() => {
    console.log('10')
})
console.log('11')

// æœ€ç»ˆç»“æœğŸ‘‰: 5 1 3 4 7 11 8 9 AAA 10 6
```

ğŸ‘€ åšé”™äº†å§ï¼Ÿ

å“ˆå“ˆæ²¡å…³ç³»

> æ­¥éª¤æ‹†åˆ† ğŸ‘‡ï¼š
>
> 1. å…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œè¾“å‡º`5`
>
> 2. æ‰§è¡Œ`setTimeout`ï¼Œæ˜¯æ”¾å…¥å®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—ä¸­
>
> 3. æ¥ç€æ‰§è¡Œ`async1`å‡½æ•°ï¼Œè¾“å‡º`1`
>
> 4. æ‰§è¡Œ`async2`å‡½æ•°ï¼Œè¾“å‡º`3`
>
> 5. `Promise`æ„é€ å™¨ä¸­ä»£ç å±äºåŒæ­¥ä»£ç ï¼Œè¾“å‡º`4`
>
>    > `async2`å‡½æ•°çš„è¿”å›å€¼æ˜¯`Promise`ï¼Œç­‰å¾…`2`ä¸ª`then`åæ”¾è¡Œï¼Œæ‰€ä»¥`AAA`æš‚æ—¶æ— æ³•è¾“å‡º
>
> 6. `async1`å‡½æ•°**æš‚æ—¶**ç»“æŸï¼Œç»§ç»­å¾€ä¸‹èµ°ï¼Œè¾“å‡º`7`
>
> 7. åŒæ­¥ä»£ç ï¼Œè¾“å‡º`11`
>
> 8. æ‰§è¡Œç¬¬ä¸€ä¸ª`then`ï¼Œè¾“å‡º`8`
>
> 9. æ‰§è¡Œç¬¬äºŒä¸ª`then`ï¼Œè¾“å‡º`9`
>
> 10. ç»ˆäº**ç­‰**åˆ°äº†ä¸¤ä¸ª`then`æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œ`async1`å‡½æ•°é‡Œé¢å‰©ä¸‹çš„ï¼Œè¾“å‡º`AAA`
>
> 11. å†æ‰§è¡Œæœ€åä¸€ä¸ªå¾®ä»»åŠ¡`then`ï¼Œè¾“å‡º`10`
>
> 12. æ‰§è¡Œæœ€åçš„å®ä»»åŠ¡`setTimeout`ï¼Œè¾“å‡º`6`

â“ æ˜¯ä¸æ˜¯è±ç„¶å¼€æœ—ï¼Œæ¬¢è¿ç‚¹èµæ”¶è—ï¼

## 2ã€await å³å€¼ç±»å‹åŒºåˆ«

---

### 2.1ã€é `thenable`

ğŸŒ°1ï¼š

```
async function test () {
    console.log(1);
    await 1;
    console.log(2);
}

test();
console.log(3);
// æœ€ç»ˆç»“æœğŸ‘‰: 1 3 2
```

ğŸŒ°2ï¼š

```
function func () {
    console.log(2);
}

async function test () {
    console.log(1);
    await func();
    console.log(3);
}

test();
console.log(4);

// æœ€ç»ˆç»“æœğŸ‘‰: 1 2 4 3
```

ğŸŒ°3ï¼š

```
async function test () {
    console.log(1);
    await 123
    console.log(2);
}

test();
console.log(3);

Promise.resolve()
    .then(() => console.log(4))
    .then(() => console.log(5))
    .then(() => console.log(6))
    .then(() => console.log(7));

// æœ€ç»ˆç»“æœğŸ‘‰: 1 3 2 4 5 6 7
```

> Note:
>
> `await`åé¢æ¥é `thenable` ç±»å‹ï¼Œä¼šç«‹å³å‘å¾®ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡`then`ï¼Œ**ä½†ä¸éœ€ç­‰å¾…**

### 2.2ã€`thenable`ç±»å‹

```
async function test () {
    console.log(1);
    await {
        then (cb) {
            cb();
        },
    };
    console.log(2);
}

test();
console.log(3);

Promise.resolve()
    .then(() => console.log(4))
    .then(() => console.log(5))
    .then(() => console.log(6))
    .then(() => console.log(7));

// æœ€ç»ˆç»“æœğŸ‘‰: 1 3 4 2 5 6 7
```

> Note:
>
> `await` åé¢æ¥ `thenable` ç±»å‹ï¼Œéœ€è¦**ç­‰å¾…ä¸€ä¸ª `then` çš„æ—¶é—´ä¹‹å**æ‰§è¡Œ

### 2.3ã€`Promise`ç±»å‹

```
async function test () {
    console.log(1);
    await new Promise((resolve, reject) => {
        resolve()
    })
    console.log(2);
}

test();
console.log(3);

Promise.resolve()
    .then(() => console.log(4))
    .then(() => console.log(5))
    .then(() => console.log(6))
    .then(() => console.log(7));

// æœ€ç»ˆç»“æœğŸ‘‰: 1 3 2 4 5 6 7
```

â“ ä¸ºä»€ä¹ˆè¡¨ç°çš„å’Œé `thenable` å€¼ä¸€æ ·å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ç­‰å¾…ä¸¤ä¸ª `then` çš„æ—¶é—´å‘¢ï¼Ÿ

> Note:
>
> - TC 39(ECMAScript æ ‡å‡†åˆ¶å®šè€…) å¯¹`await` åé¢æ˜¯ `promise` çš„æƒ…å†µå¦‚ä½•å¤„ç†è¿›è¡Œäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œ**ç§»é™¤**äº†é¢å¤–çš„ä¸¤ä¸ªå¾®ä»»åŠ¡ï¼Œåœ¨**æ—©æœŸç‰ˆæœ¬**ï¼Œä¾ç„¶ä¼šç­‰å¾…ä¸¤ä¸ª `then` çš„æ—¶é—´
> - æœ‰å¤§ä½¬ç¿»è¯‘äº†å®˜æ–¹è§£é‡Šï¼š**æ›´å¿«çš„ async å‡½æ•°å’Œ promises**[1]ï¼Œä½†åœ¨è¿™æ¬¡æ›´æ–°ä¸­å¹¶æ²¡æœ‰ä¿®æ”¹ `thenable` çš„æƒ…å†µ

---

è¿™æ ·åšå¯ä»¥æå¤§çš„ä¼˜åŒ– `await` ç­‰å¾…çš„é€Ÿåº¦ ğŸ‘‡

```
async function func () {
    console.log(1);
    await 1;
    console.log(2);
    await 2;
    console.log(3);
    await 3;
    console.log(4);
}

async function test () {
    console.log(5);
    await func();
    console.log(6);
}

test();
console.log(7);

Promise.resolve()
    .then(() => console.log(8))
    .then(() => console.log(9))
    .then(() => console.log(10))
    .then(() => console.log(11));

// æœ€ç»ˆç»“æœğŸ‘‰: 5 1 7 2 8 3 9 4 10 6 11
```

> Noteï¼š
>
> `await` å’Œ `Promise.prototype.then` è™½ç„¶å¾ˆå¤šæ—¶å€™å¯ä»¥åœ¨**æ—¶é—´é¡ºåº**ä¸Šèƒ½ç­‰æ•ˆï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´æœ‰**æœ¬è´¨çš„åŒºåˆ«**ã€‚

> - `test` å‡½æ•°ä¸­çš„ `await` ä¼šç­‰å¾… `func` å‡½æ•°ä¸­æ‰€æœ‰çš„ `await` å–å¾— æ¢å¤å‡½æ•°æ‰§è¡Œ çš„å‘½ä»¤å¹¶ä¸”æ•´ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åæ‰èƒ½è·å¾—å–å¾— **æ¢å¤å‡½æ•°æ‰§è¡Œ**çš„å‘½ä»¤ï¼›
> - ä¹Ÿå°±æ˜¯è¯´ï¼Œ`func` å‡½æ•°çš„ `await` æ­¤æ—¶**ä¸èƒ½åœ¨æ—¶é—´çš„é¡ºåºä¸Šç­‰æ•ˆ** `then`ï¼Œè€Œè¦ç­‰å¾…åˆ° `test` å‡½æ•°å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼›
> - æ¯”å¦‚è¿™é‡Œçš„æ•°å­—`6`å¾ˆæ™šæ‰è¾“å‡ºï¼Œ**å¦‚æœ**å•çº¯çœ‹æˆ`then`çš„è¯ï¼Œåœ¨ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œæ—¶`6`å°±åº”è¯¥ä½œä¸ºåŒæ­¥ä»£ç è¾“å‡ºäº†æ‰å¯¹ã€‚

---

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆå¹¶ä¸¤ä¸ªå‡½æ•°çš„ä»£ç  ğŸ‘‡

```
async function test () {
    console.log(5);

    console.log(1);
    await 1;
    console.log(2);
    await 2;
    console.log(3);
    await 3;
    console.log(4);
    await null;

    console.log(6);
}

test();
console.log(7);

Promise.resolve()
    .then(() => console.log(8))
    .then(() => console.log(9))
    .then(() => console.log(10))
    .then(() => console.log(11));

// æœ€ç»ˆç»“æœğŸ‘‰: 5 1 7 2 8 3 9 4 10 6 11
```

---

å› ä¸ºå°†åŸæœ¬çš„å‡½æ•°èåˆï¼Œæ­¤æ—¶çš„ `await` å¯ä»¥ç­‰æ•ˆä¸º `Promise.prototype.then`ï¼Œåˆå®Œå…¨å¯ä»¥ç­‰æ•ˆå¦‚ä¸‹ä»£ç  ğŸ‘‡

```
async function test () {
    console.log(5);
    console.log(1);
    Promise.resolve()
        .then(() => console.log(2))
        .then(() => console.log(3))
        .then(() => console.log(4))
        .then(() => console.log(6))
}

test();
console.log(7);

Promise.resolve()
    .then(() => console.log(8))
    .then(() => console.log(9))
    .then(() => console.log(10))
    .then(() => console.log(11));

// æœ€ç»ˆç»“æœğŸ‘‰: 5 1 7 2 8 3 9 4 10 6 11
```

---

ä»¥ä¸Šä¸‰ç§å†™æ³•åœ¨æ—¶é—´çš„é¡ºåºä¸Šå®Œå…¨ç­‰æ•ˆï¼Œæ‰€ä»¥ä½  **å®Œå…¨å¯ä»¥å°† `await` åé¢çš„ä»£ç å¯ä»¥çœ‹åšåœ¨ `then` é‡Œé¢æ‰§è¡Œçš„ç»“æœ**ï¼Œåˆå› ä¸º `async` å‡½æ•°ä¼šè¿”å› `promise` å®ä¾‹ï¼Œæ‰€ä»¥è¿˜å¯ä»¥ç­‰æ•ˆæˆ ğŸ‘‡

```
async function test () {
    console.log(5);
    console.log(1);
}

test()
    .then(() => console.log(2))
    .then(() => console.log(3))
    .then(() => console.log(4))
    .then(() => console.log(6))

console.log(7);

Promise.resolve()
    .then(() => console.log(8))
    .then(() => console.log(9))
    .then(() => console.log(10))
    .then(() => console.log(11));

// æœ€ç»ˆç»“æœğŸ‘‰: 5 1 7 2 8 3 9 4 10 6 11
```

å¯ä»¥å‘ç°ï¼Œ`test` å‡½æ•°å…¨æ˜¯èµ°çš„åŒæ­¥ä»£ç ...

æ‰€ä»¥ ğŸ‘‰ï¼š**`async/await` æ˜¯ç”¨åŒæ­¥çš„æ–¹å¼ï¼Œæ‰§è¡Œå¼‚æ­¥æ“ä½œ**

## 3ã€ğŸŒ°

---

ğŸŒ°1ï¼š

```
async function async2 () {
    new Promise((resolve, reject) => {
        resolve()
    })
}

async function async3 () {
    return new Promise((resolve, reject) => {
        resolve()
    })
}

async function async1 () {
    // æ–¹å¼ä¸€ï¼šæœ€ç»ˆç»“æœï¼šB A C D
    // await new Promise((resolve, reject) => {
    //     resolve()
    // })

    // æ–¹å¼äºŒï¼šæœ€ç»ˆç»“æœï¼šB A C D
    // await async2()

    // æ–¹å¼ä¸‰ï¼šæœ€ç»ˆç»“æœï¼šB C D A
    await async3()

    console.log('A')
}

async1()

new Promise((resolve) => {
    console.log('B')
    resolve()
}).then(() => {
    console.log('C')
}).then(() => {
    console.log('D')
})
```

> å¤§è‡´æ€è·¯ ğŸ‘‡ï¼š
>
> - é¦–å…ˆï¼Œ**`async`å‡½æ•°çš„æ•´ä½“è¿”å›å€¼æ°¸è¿œéƒ½æ˜¯`Promise`ï¼Œæ— è®ºå€¼æœ¬èº«æ˜¯ä»€ä¹ˆ**
> - æ–¹å¼ä¸€ï¼š`await`çš„æ˜¯`Promise`ï¼Œæ— éœ€ç­‰å¾…
> - æ–¹å¼äºŒï¼š`await`çš„æ˜¯`async`å‡½æ•°ï¼Œä½†æ˜¯è¯¥å‡½æ•°çš„è¿”å›å€¼æœ¬èº«æ˜¯**é`thenable`**ï¼Œæ— éœ€ç­‰å¾…
> - æ–¹å¼ä¸‰ï¼š`await`çš„æ˜¯`async`å‡½æ•°ï¼Œä¸”è¿”å›å€¼æœ¬èº«æ˜¯`Promise`ï¼Œéœ€ç­‰å¾…ä¸¤ä¸ª`then`æ—¶é—´

ğŸŒ°2ï¼š

```
function func () {
    console.log(2);

    // æ–¹å¼ä¸€ï¼š1 2 4  5 3 6 7
    // Promise.resolve()
    //     .then(() => console.log(5))
    //     .then(() => console.log(6))
    //     .then(() => console.log(7))

    // æ–¹å¼äºŒï¼š1 2 4  5 6 7 3
    return Promise.resolve()
        .then(() => console.log(5))
        .then(() => console.log(6))
        .then(() => console.log(7))
}

async function test () {
    console.log(1);
    await func();
    console.log(3);
}

test();
console.log(4);
```

> æ­¥éª¤æ‹†åˆ† ğŸ‘‡ï¼š
>
> - æ–¹å¼ä¸€ï¼š
>
> - - åŒæ­¥ä»£ç è¾“å‡º`1ã€2`ï¼Œæ¥ç€å°†`log(5)`å¤„çš„`then1`åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œ`await`æ‹¿åˆ°ç¡®åˆ‡çš„`func`å‡½æ•°è¿”å›å€¼`undefined`ï¼Œå°†åç»­ä»£ç æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆ`then2`ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼‰
>   - æ‰§è¡ŒåŒæ­¥ä»£ç è¾“å‡º`4`ï¼Œåˆ°æ­¤ï¼Œæ‰€æœ‰åŒæ­¥ä»£ç å®Œæ¯•
>   - æ‰§è¡Œç¬¬ä¸€ä¸ªæ”¾å…¥çš„å¾®ä»»åŠ¡`then1`è¾“å‡º`5`ï¼Œäº§ç”Ÿ`log(6)`çš„å¾®ä»»åŠ¡`then3`
>   - æ‰§è¡Œç¬¬äºŒä¸ªæ”¾å…¥çš„å¾®ä»»åŠ¡`then2`è¾“å‡º`3`
>   - ç„¶åæ‰§è¡Œå¾®ä»»åŠ¡`then3`ï¼Œè¾“å‡º`6`ï¼Œäº§ç”Ÿ`log(7)`çš„å¾®ä»»åŠ¡`then4`
>   - æ‰§è¡Œ`then4`ï¼Œè¾“å‡º`7`
>
> - æ–¹å¼äºŒï¼š
>
> - - åŒæ­¥ä»£ç è¾“å‡º`1ã€2`ï¼Œ`await`æ‹¿åˆ°`func`å‡½æ•°è¿”å›å€¼ï¼Œä½†æ˜¯å¹¶æœªè·å¾—**å…·ä½“çš„ç»“æœ**ï¼ˆç”±`Promise`æœ¬èº«æœºåˆ¶å†³å®šï¼‰ï¼Œæš‚åœæ‰§è¡Œå½“å‰`async`å‡½æ•°å†…çš„ä»£ç ï¼ˆè·³å‡ºã€è®©è¡Œï¼‰
>   - è¾“å‡º`4`ï¼Œåˆ°æ­¤ï¼Œæ‰€æœ‰åŒæ­¥ä»£ç å®Œæ¯•
>   - `await`ä¸€ç›´ç­‰åˆ°`Promise.resolve().then...`æ‰§è¡Œå®Œæˆï¼Œå†æ”¾è¡Œè¾“å‡º`3`

æ–¹å¼äºŒæ²¡å¤ªæ˜ç™½ â“

ç»§ç»­ ğŸ‘‡

```
function func () {
    console.log(2);

    return Promise.resolve()
        .then(() => console.log(5))
        .then(() => console.log(6))
        .then(() => console.log(7))
}

async function test () {
    console.log(1);
    await func()
    console.log(3);
}

test();
console.log(4);

new Promise((resolve) => {
    console.log('B')
    resolve()
}).then(() => {
    console.log('C')
}).then(() => {
    console.log('D')
})

// æœ€ç»ˆç»“æœğŸ‘‰: 1 2 4    B 5 C 6 D 7 3
```

è¿˜æ˜¯æ²¡æ‡‚ï¼Ÿ

ç»§ç»­ ğŸ‘‡

```
async function test () {
    console.log(1);
    await Promise.resolve()
        .then(() => console.log(5))
        .then(() => console.log(6))
        .then(() => console.log(7))
    console.log(3);
}

test();
console.log(4);

new Promise((resolve) => {
    console.log('B')
    resolve()
}).then(() => {
    console.log('C')
}).then(() => {
    console.log('D')
})

// æœ€ç»ˆç»“æœğŸ‘‰: 1 4    B 5 C 6 D 7 3
```

> Note:
>
> ç»¼ä¸Šï¼Œ`await`ä¸€å®šè¦ç­‰åˆ°å³ä¾§çš„è¡¨è¾¾å¼æœ‰**ç¡®åˆ‡çš„å€¼**æ‰ä¼šæ”¾è¡Œï¼Œå¦åˆ™å°†ä¸€ç›´ç­‰å¾…ï¼ˆé˜»å¡å½“å‰`async`å‡½æ•°å†…çš„åç»­ä»£ç ï¼‰ï¼Œä¸æœçœ‹çœ‹è¿™ä¸ª ğŸ‘‡
>
> - ```
>   function func () {
>     return new Promise((resolve) => {
>         console.log('B')
>         // resolve() æ•…æ„ä¸€ç›´ä¿æŒpending
>     })
>   }
>
>   async function test () {
>     console.log(1);
>     await func()
>     console.log(3);
>   }
>
>   test();
>   console.log(4);
>   // æœ€ç»ˆç»“æœğŸ‘‰: 1 B 4 (æ°¸è¿œä¸ä¼šæ‰“å°3)
>
>
>   // ---------------------æˆ–è€…å†™ä¸ºğŸ‘‡-------------------
>   async function test () {
>     console.log(1);
>     await new Promise((resolve) => {
>         console.log('B')
>         // resolve() æ•…æ„ä¸€ç›´ä¿æŒpending
>     })
>     console.log(3);
>   }
>
>   test();
>   console.log(4);
>   // æœ€ç»ˆç»“æœğŸ‘‰: 1 B 4 (æ°¸è¿œä¸ä¼šæ‰“å°3)
>   ```

ğŸŒ°3ï¼š

```
async function func () {
    console.log(2);
    return {
        then (cb) {
            cb()
        }
    }
}

async function test () {
    console.log(1);
    await func();
    console.log(3);
}

test();
console.log(4);

new Promise((resolve) => {
    console.log('B')
    resolve()
}).then(() => {
    console.log('C')
}).then(() => {
    console.log('D')
})

// æœ€ç»ˆç»“æœğŸ‘‰: 1 2 4 B C 3 D
```

> æ­¥éª¤æ‹†åˆ† ğŸ‘‡ï¼š
>
> - åŒæ­¥ä»£ç è¾“å‡º`1ã€2`
> - `await`æ‹¿åˆ°`func`å‡½æ•°çš„å…·ä½“è¿”å›å€¼`thenable`ï¼Œå°†å½“å‰`async`å‡½æ•°å†…çš„åç»­ä»£ç æ”¾å…¥å¾®ä»»åŠ¡`then1`(ä½†æ˜¯éœ€è¦ç­‰å¾…ä¸€ä¸ª`then`æ—¶é—´)
> - åŒæ­¥ä»£ç è¾“å‡º`4ã€B`ï¼Œäº§ç”Ÿ`log(C)`çš„å¾®ä»»åŠ¡`then2`
> - ç”±äº`then1`æ»åä¸€ä¸ª`then`æ—¶é—´ï¼Œç›´æ¥æ‰§è¡Œ`then2`è¾“å‡º`C`ï¼Œäº§ç”Ÿ`log(D)`çš„å¾®ä»»åŠ¡`then3`
> - æ‰§è¡ŒåŸæœ¬æ»åä¸€ä¸ª`then`æ—¶é—´çš„å¾®ä»»åŠ¡`then1`ï¼Œè¾“å‡º`3`
> - æ‰§è¡Œæœ€åä¸€ä¸ªå¾®ä»»åŠ¡`then3`è¾“å‡º`D`

## 4ã€æ€»ç»“

---

> `async`å‡½æ•°è¿”å›å€¼
>
> - ğŸ“‘ ç»“è®ºï¼š`async`å‡½æ•°åœ¨æŠ›å‡ºè¿”å›å€¼æ—¶ï¼Œä¼šæ ¹æ®è¿”å›å€¼**ç±»å‹**å¼€å¯**ä¸åŒæ•°ç›®çš„å¾®ä»»åŠ¡**
>
> - - return ç»“æœå€¼ï¼šé`thenable`ã€é`promise`ï¼ˆä¸ç­‰å¾…ï¼‰
>   - return ç»“æœå€¼ï¼š`thenable`ï¼ˆç­‰å¾… 1 ä¸ª`then`çš„æ—¶é—´ï¼‰
>   - return ç»“æœå€¼ï¼š`promise`ï¼ˆç­‰å¾… 2 ä¸ª`then`çš„æ—¶é—´ï¼‰
>
> `await`å³å€¼ç±»å‹åŒºåˆ«
>
> - æ¥é `thenable` ç±»å‹ï¼Œä¼šç«‹å³å‘å¾®ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡`then`ï¼Œ**ä½†ä¸éœ€ç­‰å¾…**
>
> - æ¥ `thenable` ç±»å‹ï¼Œéœ€è¦**ç­‰å¾…ä¸€ä¸ª `then` çš„æ—¶é—´ä¹‹å**æ‰§è¡Œ
>
> - æ¥`Promise`ç±»å‹(æœ‰ç¡®å®šçš„è¿”å›å€¼)ï¼Œä¼šç«‹å³å‘å¾®ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡`then`ï¼Œ**ä½†ä¸éœ€ç­‰å¾…**
>
> - - TC 39 å¯¹`await` åé¢æ˜¯ `promise` çš„æƒ…å†µå¦‚ä½•å¤„ç†è¿›è¡Œäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œ**ç§»é™¤**äº†é¢å¤–çš„ä¸¤ä¸ªå¾®ä»»åŠ¡ï¼Œåœ¨**æ—©æœŸç‰ˆæœ¬**ï¼Œä¾ç„¶ä¼šç­‰å¾…ä¸¤ä¸ª `then` çš„æ—¶é—´

### å‚è€ƒèµ„æ–™

---

[1]https://juejin.cn/post/6844903715342647310#heading-3: *https://juejin.cn/post/6844903715342647310#heading-3*
